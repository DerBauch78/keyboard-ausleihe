{% extends "base.html" %}
{% block title %}Neue Ausleihe - Keyboard-Ausleihe{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto">
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Neue Ausleihe</h1>
        
        <form method="POST" class="space-y-4">
            <div>
                <label for="class_select" class="block text-sm font-medium text-gray-700 mb-1">Klasse</label>
                <select id="class_select" class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                    <option value="">Bitte wählen...</option>
                    {% for cls in classes %}
                    <option value="{{ cls.id }}">{{ cls.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="student_id" class="block text-sm font-medium text-gray-700 mb-1">Schüler *</label>
                <select id="student_id" name="student_id" required class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="">Erst Klasse wählen...</option>
                </select>
            </div>
            
            <div>
                <label for="keyboard_id" class="block text-sm font-medium text-gray-700 mb-1">Keyboard *</label>
                <select id="keyboard_id" name="keyboard_id" required class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="">Wird geladen...</option>
                </select>
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" id="fee_paid" name="fee_paid" class="h-4 w-4 text-blue-600 rounded">
                <label for="fee_paid" class="ml-2 text-sm text-gray-700">Gebühr (10€) bereits bezahlt</label>
            </div>
            
            <div class="flex justify-end gap-3 pt-4">
                <a href="{{ url_for('loans.index') }}" class="px-4 py-2 text-gray-600 hover:text-gray-800">Abbrechen</a>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Ausleihen
                </button>
            </div>
        </form>
    </div>
</div>

<script>
async function loadStudents() {
    const classId = document.getElementById('class_select').value;
    const studentSelect = document.getElementById('student_id');
    
    if (!classId) {
        studentSelect.innerHTML = '<option value="">Erst Klasse wählen...</option>';
        return;
    }
    
    try {
        const res = await fetch(`/students/api/without-loan?class_id=${classId}`);
        const students = await res.json();
        
        studentSelect.innerHTML = '<option value="">Bitte wählen...</option>';
        students.forEach(s => {
            studentSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
    } catch (e) {
        studentSelect.innerHTML = '<option value="">Fehler beim Laden</option>';
    }
}

async function loadKeyboards() {
    const keyboardSelect = document.getElementById('keyboard_id');
    
    try {
        const res = await fetch('/keyboards/api/available');
        const keyboards = await res.json();
        
        keyboardSelect.innerHTML = '<option value="">Bitte wählen...</option>';
        keyboards.forEach(k => {
            const label = k.internal_number ? `${k.inventory_number} (Nr. ${k.internal_number})` : k.inventory_number;
            keyboardSelect.innerHTML += `<option value="${k.id}">${label}</option>`;
        });
    } catch (e) {
        keyboardSelect.innerHTML = '<option value="">Fehler beim Laden</option>';
    }
}

// Keyboards beim Laden der Seite laden
loadKeyboards();
</script>
{% endblock %}
